(()=>{"use strict";function e(n){if(n instanceof Text){const t=n.parentNode;if(t){const o=Array.from(t.childNodes).findIndex((e=>e===n));return e(t)+`/text()[${o+1}]`}}else if(n instanceof Element){const t=n.parentNode;if(t){const o=Array.from(t.childNodes).findIndex((e=>e===n));return e(t)+`/*[${o+1}]`}}return null}function n(e){try{return document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}catch(n){return console.error("Invalid XPath:",e),null}}function t(e){const n=[],t=document.createTreeWalker(e.commonAncestorContainer,NodeFilter.SHOW_TEXT|NodeFilter.SHOW_ELEMENT);for(;t.nextNode();){const r=t.currentNode;o(r,e)&&n.push(r)}0===n.length&&e.commonAncestorContainer.nodeType===Node.TEXT_NODE&&n.push(e.commonAncestorContainer),n.forEach((n=>{const t=document.createElement("span");t.style.backgroundColor="yellow";const o=document.createRange();o.selectNodeContents(n),function(e,n){const t=e.cloneRange();return t.setStart(n.startContainer,n.startOffset),t.setEnd(n.endContainer,n.endOffset),t}(o,e).surroundContents(t)}))}function o(e,n){const t=document.createRange();return t.selectNodeContents(e),n.compareBoundaryPoints(Range.END_TO_START,t)<=0&&n.compareBoundaryPoints(Range.START_TO_END,t)>=0}chrome.runtime.onMessage.addListener(((e,o,r)=>{if("websiteHighlights"===e.type){const o=e.data;console.log("Recieved websiteHighlights: ",o),o.forEach((e=>{const o=function(e){const t=n(e.startContainerPath||""),o=n(e.endContainerPath||"");if(t&&o){const n=document.createRange();return n.setStart(t,e.startOffset),n.setEnd(o,e.endOffset),n}return null}(e.serializedRange);console.log("deserialized range: ",o),o&&t(o)}))}})),document.addEventListener("mouseup",(function(){const n=window.getSelection();if(n&&n.toString().length>0){const o=n.getRangeAt(0),r=n.toString(),s=window.location.href;console.log("Selected Text:",r),console.log("Website URL:",s),console.log("Range selected: ",o);const a=function(n){return{startContainerPath:e(n.startContainer),startOffset:n.startOffset,endContainerPath:e(n.endContainer),endOffset:n.endOffset}}(o),c={url:s,serializedRange:a};chrome.runtime.sendMessage({type:"newHighlight",data:c}),t(o),n.removeAllRanges()}}))})();